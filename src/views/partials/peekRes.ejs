<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
  // ===== GLOBAL STATE =====
  const workspaceId = "<%= workspaceId %>";
  let editor = null;
  let currentFile = null;

  // ===== MONACO SETUP =====
  require.config({
    paths: {
      vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"
    }
  });

  require(["vs/editor/editor.main"], function () {
    editor = monaco.editor.create(document.getElementById("editor"), {
      value: "// Select a file from the left panel",
      language: "plaintext",
      theme: "vs-dark",
      automaticLayout: false
    });

    // Force correct layout
    window.addEventListener("resize", () => editor.layout());
    setTimeout(() => editor.layout(), 0);
  });

  // ===== FILE OPEN =====
  window.openFile = async function (filePath) {
    currentFile = filePath;

    document.getElementById("current-file").textContent =
      `Editing: ${filePath}`;

    const res = await fetch(
      `/peek/file?ws=${workspaceId}&path=${encodeURIComponent(filePath)}`
    );

    const data = await res.json();
    editor.setValue(data.content || "");

    const ext = filePath.split(".").pop();
    monaco.editor.setModelLanguage(
      editor.getModel(),
      ext || "plaintext"
    );

    editor.layout();
  };

  // ===== SAVE FILE =====
  window.saveFile = async function () {
    if (!currentFile) {
      alert("No file selected");
      return;
    }

    const res = await fetch("/peek/file/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ws: workspaceId,
        path: currentFile,
        content: editor.getValue()
      })
    });

    const data = await res.json();

    if (data.success) {
      document.getElementById("current-file").textContent =
        `Saved: ${currentFile}`;
    } else {
      alert(data.error || "Save failed");
    }
  };

  // ===== DOWNLOAD ZIP =====
  window.updateAndDownload = function () {
    // Trigger download via temporary link
    const link = document.createElement('a');
    link.href = `/peek/download?ws=${workspaceId}`;
    link.download = 'updated.zip';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Redirect to peek.ejs (display route) after a short delay
    setTimeout(() => {
      window.location.href = '/peek/display';
    }, 1000);
  };

  // ===== CREATE FILE =====
  window.createFile = async function () {
    const path = prompt("Enter file path (e.g. src/new.js)");
    if (!path) {
      console.log('No path provided for new file.');
      return;
    }
    console.log('Creating file at path:', path);
    try {
      const res = await fetch("/peek/file/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        console.log('File created, reloading page.');
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to create file");
      }
    } catch (err) {
      console.error(err);
      alert("Network error or server unreachable");
    }
  };

  // ===== CREATE FOLDER =====
  window.createFolder = async function () {
    const path = prompt("Enter folder path (e.g. src/utils)");
    if (!path) return;

    try {
      const res = await fetch("/peek/folder/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to create folder");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };

  // ===== RENAME =====
  window.renameItem = async function () {
    const oldPath = prompt("Old path");
    const newPath = prompt("New path");
    if (!oldPath || !newPath) return;

    try {
      const res = await fetch("/peek/rename", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, oldPath, newPath })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to rename");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };

  // ===== DELETE =====
  window.deleteItem = async function () {
    const path = prompt("Path to delete");
    if (!path) return;

    try {
      const res = await fetch("/peek/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to delete");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };
</script>