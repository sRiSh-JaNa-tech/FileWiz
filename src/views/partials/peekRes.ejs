<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
  const EDITABLE_EXTENSIONS = [
    'js', 'json', 'txt', 'md',
    'html', 'css', 'ts', 'csv'
  ];


  function isEditable(filePath) {
    const ext = filePath.split('.').pop().toLowerCase();
    return EDITABLE_EXTENSIONS.includes(ext);
  }

  const workspaceId = "<%= workspaceId %>";
  let editor = null;
  let currentFile = null;

  // ===== MONACO SETUP =====
  require.config({
    paths: {
      vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"
    }
  });

  require(["vs/editor/editor.main"], function () {
    editor = monaco.editor.create(document.getElementById("editor"), {
      value: "// Select a file from the left panel",
      language: "plaintext",
      theme: "vs-dark",
      automaticLayout: false
    });

    // Force correct layout
    window.addEventListener("resize", () => editor.layout());
    setTimeout(() => editor.layout(), 0);
  });

  // ===== FILE OPEN =====
  let activeFileEl = null;
  window.openFile = async function (filePath, element) {
    currentFile = filePath;

    if (activeFileEl) {
      activeFileEl.classList.remove('bg-blue-100');
    }
    if (element) {
      element.classList.add('bg-blue-100');
      activeFileEl = element;
    }

    document.getElementById("current-file").textContent =
      `Editing: ${filePath}`;

    const res = await fetch(
      `/peek/file?ws=${workspaceId}&path=${encodeURIComponent(filePath)}`
    );

    const data = await res.json();
    editor.setValue(data.content || "");

    const ext = filePath.split(".").pop();
    monaco.editor.setModelLanguage(
      editor.getModel(),
      ext || "plaintext"
    );

    const editable = isEditable(filePath);
    editor.updateOptions({ readOnly: !editable });

    // ðŸ”‘ Toggle Save button
    document.getElementById('save-btn').disabled = !editable;

    // UI feedback
    if (!editable) {
      document.getElementById('current-file').textContent += ' (read-only)';
    }
    editor.layout();
  };

  // ===== SAVE FILE =====
  window.saveFile = async function () {
    if (!currentFile) {
      alert("No file selected");
      return;
    }

    if (!isEditable(currentFile)) {
      alert('This file is read-only');
      return;
    }

    const res = await fetch("/peek/file/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ws: workspaceId,
        path: currentFile,
        content: editor.getValue()
      })
    });

    const data = await res.json();

    if (data.success) {
      document.getElementById("current-file").textContent =
        `Saved: ${currentFile}`;
    } else {
      alert(data.error || "Save failed");
    }
  };

  // ===== DOWNLOAD ZIP =====
  window.updateAndDownload = function () {
    // Trigger download via temporary link
    const link = document.createElement('a');
    link.href = `/peek/download?ws=${workspaceId}`;
    link.download = 'updated.zip';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Redirect to peek.ejs (display route) after a short delay
    setTimeout(() => {
      window.location.href = '/peek/display';
    }, 1000);
  };

  window.refreshTree = async function () {
    const res = await fetch(`/peek/tree?ws=${workspaceId}`);
    const tree = await res.json();

    const container = document.getElementById('file-tree');
    container.innerHTML = renderTreeHTML(tree);
  };

  window.oncontextmenu = function (e) {
    const fileEl = e.target.closest('.file');
    if (!fileEl) return;

    e.preventDefault();
    const path = fileEl.dataset.path;

    const action = prompt(`Action for ${path}\n1: Rename\n2: Delete`);

    if (action === '1') renameItem(path);
    if (action === '2') deleteItem(path);
  };


  // ===== CREATE FILE =====
  window.createFile = async function () {
    const path = prompt("Enter file path (e.g. src/new.js)");
    if (!path) {
      console.log('No path provided for new file.');
      return;
    }
    console.log('Creating file at path:', path);
    try {
      const res = await fetch("/peek/file/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        console.log('File created, reloading page.');
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to create file");
      }
    } catch (err) {
      console.error(err);
      alert("Network error or server unreachable");
    }
  };

  // ===== CREATE FOLDER =====
  window.createFolder = async function () {
    const path = prompt("Enter folder path (e.g. src/utils)");
    if (!path) return;

    try {
      const res = await fetch("/peek/folder/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to create folder");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };

  // ===== RENAME =====
  window.renameItem = async function (targetPath) {
    const oldPath = targetPath || currentFile || prompt("Old path");
    if (!oldPath) return;

    const newPath = prompt("New path", oldPath);
    if (!newPath || newPath === oldPath) return;

    try {
      const res = await fetch("/peek/rename", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, oldPath, newPath })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to rename");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };

  // ===== DELETE =====
  window.deleteItem = async function (targetPath) {
    const path = targetPath || currentFile || prompt("Path to delete");
    if (!path) return;

    if (!confirm(`Are you sure you want to delete ${path}?`)) return;

    try {
      const res = await fetch("/peek/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ws: workspaceId, path })
      });

      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || "Failed to delete");
      }
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  };

  window.toggleFolder = function (el) {
    const children = el.nextElementSibling;
    const arrow = el.querySelector('.arrow');

    children.classList.toggle('hidden');
    arrow.textContent = children.classList.contains('hidden') ? 'â–¶' : 'â–¼';
  };

</script>